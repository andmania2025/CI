// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/client"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [postgis, pg_trgm, uuid_ossp]
}

// ============================================
// ユーザー・権限管理 [yellow]
// RLS: auth.uid() でアクセス制御
// ============================================

model User {
  id              String     @id @default(uuid()) @db.Uuid
  email           String     @unique @db.VarChar(255)
  name            String?    @db.VarChar(100)
  furigana        String?    @db.VarChar(100)
  gender          Gender?
  birthDate       DateTime?  @db.Date
  phone           String?    @db.VarChar(20)
  avatarUrl       String?    @db.VarChar(500)
  status          UserStatus @default(ACTIVE)
  emailVerifiedAt DateTime?  @db.Timestamptz
  createdAt       DateTime   @default(now()) @db.Timestamptz
  updatedAt       DateTime   @updatedAt @db.Timestamptz
  deletedAt       DateTime?  @db.Timestamptz
  lastLoginAt     DateTime?  @db.Timestamptz

  // Relations
  userRoles             UserRole[]
  agent                 Agent?
  properties            Property[]
  inquiries             Inquiry[]
  favorites             Favorite[]
  propertyViews         PropertyView[]
  questions             Question[]
  answers               Answer[]
  bulkAssessments       BulkAssessment[]
  mails                 Mail[]
  fileBoxes             FileBox[]
  notifications         Notification[]
  systemSettingsUpdated SystemSetting[]
  auditLogs             AuditLog[]
  priceHistoryChanges   PropertyPriceHistory[]
  statusHistoryChanges  PropertyStatusHistory[]

  @@index([status])
  @@index([email])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(50) // admin, agent, general
  permissions Json?    @db.JsonB // 権限をJSONBで柔軟に管理
  description String?  @db.Text
  createdAt   DateTime @default(now()) @db.Timestamptz

  // Relations
  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  roleId    String   @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  WITHDRAWN
}

// ============================================
// 不動産会社・支店・担当者 [blue]
// 3層構造: Company → Branch → Agent
// ============================================

model Company {
  id                    String        @id @default(uuid()) @db.Uuid
  companyName           String        @db.VarChar(200)
  companyNameKana       String?       @db.VarChar(200) // 検索用
  representativeName    String        @db.VarChar(100)
  postalCode            String        @db.VarChar(8)
  prefecture            String        @db.VarChar(10)
  city                  String        @db.VarChar(50)
  address               String        @db.Text
  latitude              Decimal?      @db.Decimal(10, 7)
  longitude             Decimal?      @db.Decimal(10, 7)
  phone                 String        @db.VarChar(20)
  fax                   String?       @db.VarChar(20)
  website               String?       @db.VarChar(500)
  licenseNumber         String        @unique @db.VarChar(100)
  associationMembership String?       @db.VarChar(200)
  accountType           AccountType   @default(FREE)
  status                CompanyStatus @default(PENDING)
  metadata              Json?         @db.JsonB
  createdAt             DateTime      @default(now()) @db.Timestamptz
  updatedAt             DateTime      @updatedAt @db.Timestamptz
  deletedAt             DateTime?     @db.Timestamptz

  // Relations
  branches Branch[]

  @@index([status])
  @@index([prefecture, city])
  @@map("companies")
}

model Branch {
  id             String    @id @default(uuid()) @db.Uuid
  branchName     String    @db.VarChar(200)
  postalCode     String    @db.VarChar(8)
  prefecture     String    @db.VarChar(10)
  city           String    @db.VarChar(50)
  address        String    @db.Text
  latitude       Decimal?  @db.Decimal(10, 7)
  longitude      Decimal?  @db.Decimal(10, 7)
  phone          String    @db.VarChar(20)
  fax            String?   @db.VarChar(20)
  businessHours  String?   @db.VarChar(100)
  isHeadquarters Boolean   @default(false)
  companyId      String    @db.Uuid
  createdAt      DateTime  @default(now()) @db.Timestamptz
  updatedAt      DateTime  @updatedAt @db.Timestamptz
  deletedAt      DateTime? @db.Timestamptz

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  agents  Agent[]

  @@index([companyId])
  @@map("branches")
}

model Agent {
  id                 String    @id @default(uuid()) @db.Uuid
  position           String?   @db.VarChar(100)
  department         String?   @db.VarChar(100)
  licenseNumber      String?   @db.VarChar(100) // 宅建士番号
  licenseExpireDate  DateTime? @db.Date
  goodCount          Int       @default(0)
  responseRate       Decimal?  @db.Decimal(5, 2) // 返信率
  avgResponseMinutes Int? // 平均返信時間
  userId             String    @unique @db.Uuid
  branchId           String    @db.Uuid
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now()) @db.Timestamptz
  updatedAt          DateTime  @updatedAt @db.Timestamptz
  deletedAt          DateTime? @db.Timestamptz

  // Relations
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch                  Branch                   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  properties              Property[]
  assignedInquiries       Inquiry[]
  answers                 Answer[]
  bulkAssessmentResponses BulkAssessmentResponse[]

  @@index([branchId, isActive])
  @@index([userId])
  @@map("agents")
}

enum AccountType {
  FREE
  BASIC
  PREMIUM
}

enum CompanyStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

// ============================================
// 物件情報 [green]
// 検索最適化のため一部非正規化
// ============================================

model Property {
  id               String  @id @default(uuid()) @db.Uuid
  propertyCode     String  @unique @db.VarChar(50) // 物件番号
  propertyName     String  @db.VarChar(200)
  propertyNameKana String? @db.VarChar(200) // 検索用

  // マスタ参照
  propertyTypeId     String? @db.Uuid
  propertyCategoryId String? @db.Uuid
  areaId             String? @db.Uuid

  // 取引情報
  transactionType   TransactionType?
  propertyCondition PropertyCondition?

  // 住所
  postalCode  String?  @db.VarChar(8)
  prefecture  String?  @db.VarChar(10)
  city        String?  @db.VarChar(50)
  town        String?  @db.VarChar(100)
  block       String?  @db.VarChar(50)
  building    String?  @db.VarChar(100)
  roomNumber  String?  @db.VarChar(50)
  fullAddress String?  @db.Text // 検索用結合済み住所
  latitude    Decimal? @db.Decimal(10, 7)
  longitude   Decimal? @db.Decimal(10, 7)

  // 間取り・面積
  layoutNumber  Int? // 部屋数
  layoutTypeId  String?  @db.Uuid
  layoutDisplay String?  @db.VarChar(20) // "3LDK" 等
  buildingArea  Decimal? @db.Decimal(10, 2)
  landArea      Decimal? @db.Decimal(10, 2)
  balconyArea   Decimal? @db.Decimal(10, 2)

  // 建物情報
  buildingStructure     String?   @db.VarChar(50)
  constructionDate      DateTime? @db.Date
  constructionYearMonth String?   @db.VarChar(20) // "2020年3月" 表示用
  totalFloors           Int?
  floor                 Int?

  // 価格
  currentPrice     BigInt? // 円単位
  pricePerTsubo    BigInt? // 坪単価（計算済みキャッシュ）
  managementFee    Int?
  commonServiceFee Int?
  depositMonths    Decimal? @db.Decimal(3, 1) // 敷金（ヶ月）
  keyMoneyMonths   Decimal? @db.Decimal(3, 1) // 礼金（ヶ月）

  // 非正規化フィールド（一覧表示高速化）
  mainImageUrl              String?  @db.VarChar(500)
  primaryStationName        String?  @db.VarChar(100)
  primaryStationWalkMinutes Int?
  featureTags               String[] // 設備タグ配列

  // 統計
  viewCount     Int @default(0)
  inquiryCount  Int @default(0)
  favoriteCount Int @default(0)

  // 管理
  agentId      String?   @db.Uuid
  remarks      String?   @db.Text
  internalMemo String?   @db.Text // 社内メモ
  metadata     Json?     @db.JsonB
  createdAt    DateTime  @default(now()) @db.Timestamptz
  updatedAt    DateTime  @updatedAt @db.Timestamptz
  deletedAt    DateTime? @db.Timestamptz

  // Relations
  propertyType     PropertyTypeMaster?     @relation(fields: [propertyTypeId], references: [id], onDelete: SetNull)
  propertyCategory PropertyCategoryMaster? @relation(fields: [propertyCategoryId], references: [id], onDelete: SetNull)
  area             AreaMaster?             @relation(fields: [areaId], references: [id], onDelete: SetNull)
  layoutType       FloorPlanMaster?        @relation(fields: [layoutTypeId], references: [id], onDelete: SetNull)
  agent            Agent?                  @relation(fields: [agentId], references: [id], onDelete: SetNull)

  // 所有者（管理者）
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // サブテーブル
  publication         PropertyPublication?
  priceHistories      PropertyPriceHistory[]
  statusHistories     PropertyStatusHistory[]
  images              PropertyImage[]
  features            PropertyFeature[]
  stations            PropertyStation[]
  inquiries           Inquiry[]
  favorites           Favorite[]
  propertyViews       PropertyView[]
  propertyViewDailies PropertyViewDaily[]

  @@index([userId])
  @@index([agentId])
  @@index([prefecture, city, propertyTypeId])
  @@index([currentPrice])
  @@index([transactionType])
  @@index([createdAt(sort: Desc)])
  @@map("properties")
}

model PropertyPublication {
  id            String            @id @default(uuid()) @db.Uuid
  propertyId    String            @unique @db.Uuid
  status        PublicationStatus @default(DRAFT)
  scope         PublicScope       @default(PRIVATE)
  featured      Boolean           @default(false)
  featuredOrder Int?
  publishedAt   DateTime?         @db.Timestamptz
  unpublishedAt DateTime?         @db.Timestamptz
  soldAt        DateTime?         @db.Timestamptz
  expiresAt     DateTime?         @db.Timestamptz
  createdAt     DateTime          @default(now()) @db.Timestamptz
  updatedAt     DateTime          @updatedAt @db.Timestamptz

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([status, scope])
  @@index([featured, featuredOrder])
  @@map("property_publications")
}

// ============================================
// 物件履歴 [green]
// ============================================

model PropertyPriceHistory {
  id            String   @id @default(uuid()) @db.Uuid
  propertyId    String   @db.Uuid
  previousPrice BigInt?
  newPrice      BigInt
  changePercent Decimal? @db.Decimal(5, 2) // 変動率
  changeReason  String?  @db.Text
  changedById   String?  @db.Uuid
  createdAt     DateTime @default(now()) @db.Timestamptz

  // Relations
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  changedBy User?    @relation(fields: [changedById], references: [id], onDelete: SetNull)

  @@index([propertyId, createdAt(sort: Desc)])
  @@map("property_price_histories")
}

model PropertyStatusHistory {
  id             String   @id @default(uuid()) @db.Uuid
  propertyId     String   @db.Uuid
  previousStatus String?  @db.VarChar(50)
  newStatus      String   @db.VarChar(50)
  changeReason   String?  @db.Text
  changedById    String?  @db.Uuid
  createdAt      DateTime @default(now()) @db.Timestamptz

  // Relations
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  changedBy User?    @relation(fields: [changedById], references: [id], onDelete: SetNull)

  @@index([propertyId, createdAt(sort: Desc)])
  @@map("property_status_histories")
}

// ============================================
// 物件メディア・設備 [orange/purple]
// ============================================

model PropertyImage {
  id           String    @id @default(uuid()) @db.Uuid
  propertyId   String    @db.Uuid
  fileBoxId    String?   @db.Uuid
  url          String    @db.VarChar(500)
  thumbnailUrl String?   @db.VarChar(500)
  caption      String?   @db.VarChar(200)
  imageType    ImageType @default(EXTERIOR)
  displayOrder Int       @default(0)
  isMain       Boolean   @default(false)
  width        Int?
  height       Int?
  createdAt    DateTime  @default(now()) @db.Timestamptz

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  fileBox  FileBox? @relation(fields: [fileBoxId], references: [id], onDelete: SetNull)

  @@index([propertyId, displayOrder])
  @@index([propertyId, isMain])
  @@map("property_images")
}

model PropertyFeature {
  id         String @id @default(uuid()) @db.Uuid
  propertyId String @db.Uuid
  featureId  String @db.Uuid

  // Relations
  property Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  feature  FeatureMaster @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([propertyId, featureId])
  @@index([propertyId])
  @@index([featureId])
  @@map("property_features")
}

model PropertyStation {
  id          String  @id @default(uuid()) @db.Uuid
  propertyId  String  @db.Uuid
  stationId   String  @db.Uuid
  walkMinutes Int?
  busMinutes  Int?
  busStopName String? @db.VarChar(100)
  isPrimary   Boolean @default(false)

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  station  Station  @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@unique([propertyId, stationId])
  @@index([propertyId])
  @@index([stationId])
  @@map("property_stations")
}

enum ImageType {
  EXTERIOR
  INTERIOR
  FLOOR_PLAN
  MAP
  OTHER
}

enum TransactionType {
  SALE
  RENT
  BOTH
}

enum PropertyCondition {
  NEW
  USED
  RENOVATED
}

enum PublicationStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  SOLD
  HIDDEN
}

enum PublicScope {
  PUBLIC
  PRIVATE
  MEMBERS
  AGENTS
}

// ============================================
// ユーザーアクション [pink]
// ============================================

model Favorite {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  propertyId String   @db.Uuid
  createdAt  DateTime @default(now()) @db.Timestamptz

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([propertyId])
  @@map("favorites")
}

model PropertyView {
  id                  String   @id @default(uuid()) @db.Uuid
  propertyId          String   @db.Uuid
  userId              String?  @db.Uuid // nullable（非ログイン）
  sessionId           String?  @db.VarChar(100)
  ipAddress           String?  @db.VarChar(45) // IPv6対応
  userAgent           String?  @db.Text
  referer             String?  @db.Text
  viewedAt            DateTime @default(now()) @db.Timestamptz
  viewDurationSeconds Int?

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([propertyId, viewedAt(sort: Desc)])
  @@index([userId, viewedAt(sort: Desc)])
  @@map("property_views")
}

model PropertyViewDaily {
  id                 String   @id @default(uuid()) @db.Uuid
  propertyId         String   @db.Uuid
  viewDate           DateTime @db.Date
  totalViews         Int      @default(0)
  uniqueUsers        Int      @default(0)
  avgDurationSeconds Decimal? @db.Decimal(10, 2)
  createdAt          DateTime @default(now()) @db.Timestamptz

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, viewDate])
  @@index([viewDate(sort: Desc)])
  @@index([propertyId, viewDate(sort: Desc)])
  @@map("property_view_dailies")
}

// ============================================
// 問い合わせ [red]
// ============================================

model Inquiry {
  id            String     @id @default(uuid()) @db.Uuid
  inquiryNumber String     @unique @db.VarChar(50)
  targetType    TargetType
  targetId      String?    @db.Uuid

  // 問い合わせ者情報
  name        String  @db.VarChar(100)
  furigana    String? @db.VarChar(100)
  email       String  @db.VarChar(255)
  phone       String? @db.VarChar(20)
  companyName String? @db.VarChar(200)

  // 内容
  inquiryType InquiryType @default(OTHER)
  subject     String?     @db.VarChar(500)
  message     String      @db.Text

  // ステータス管理
  status   InquiryStatus   @default(NEW)
  priority InquiryPriority @default(NORMAL)

  // 担当
  userId          String?   @db.Uuid
  assignedAgentId String?   @db.Uuid
  assignedAt      DateTime? @db.Timestamptz

  // 追跡
  responseCount   Int       @default(0)
  lastRespondedAt DateTime? @db.Timestamptz
  closedAt        DateTime? @db.Timestamptz
  closedReason    String?   @db.Text

  // メタ
  source    String?  @db.VarChar(50) // web, phone, email, api
  metadata  Json?    @db.JsonB
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Relations
  user          User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  assignedAgent Agent?           @relation(fields: [assignedAgentId], references: [id], onDelete: SetNull)
  property      Property?        @relation(fields: [targetId], references: [id], onDelete: SetNull)
  messages      InquiryMessage[]

  @@index([status, priority, createdAt(sort: Desc)])
  @@index([assignedAgentId, status])
  @@index([targetType, targetId])
  @@index([userId])
  @@map("inquiries")
}

model InquiryMessage {
  id          String     @id @default(uuid()) @db.Uuid
  inquiryId   String     @db.Uuid
  senderId    String?    @db.Uuid
  senderType  SenderType
  message     String     @db.Text
  attachments Json?      @db.JsonB // [{fileBoxId, fileName}]
  isInternal  Boolean    @default(false) // 社内メモ
  createdAt   DateTime   @default(now()) @db.Timestamptz

  // Relations
  inquiry Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  @@index([inquiryId, createdAt])
  @@map("inquiry_messages")
}

enum TargetType {
  PROPERTY
  SITE
  COMPANY
  AGENT
}

enum InquiryType {
  DOCUMENT_REQUEST
  VIEWING
  PRICE_NEGOTIATION
  ENVIRONMENT
  MOVE_IN
  OTHER
}

enum InquiryStatus {
  NEW
  ASSIGNED
  IN_PROGRESS
  RESPONDED
  CLOSED
}

enum InquiryPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SenderType {
  USER
  AGENT
  SYSTEM
}

// ============================================
// 一括査定 [teal]
// ============================================

model BulkAssessment {
  id               String @id @default(uuid()) @db.Uuid
  assessmentNumber String @unique @db.VarChar(50)

  // 物件情報
  propertyAddress  String   @db.Text
  propertyTypeId   String?  @db.Uuid
  buildingArea     Decimal? @db.Decimal(10, 2)
  landArea         Decimal? @db.Decimal(10, 2)
  constructionYear Int?

  // 依頼者情報
  ownerName              String  @db.VarChar(100)
  email                  String  @db.VarChar(255)
  phone                  String? @db.VarChar(20)
  preferredContactMethod String? @db.VarChar(50)
  preferredContactTime   String? @db.VarChar(100)

  // ステータス
  status        AssessmentStatus @default(PENDING)
  agentCount    Int              @default(0) // 査定依頼した業者数
  responseCount Int              @default(0) // 返答数

  userId      String?   @db.Uuid
  metadata    Json?     @db.JsonB
  createdAt   DateTime  @default(now()) @db.Timestamptz
  completedAt DateTime? @db.Timestamptz

  // Relations
  user         User?                    @relation(fields: [userId], references: [id], onDelete: SetNull)
  propertyType PropertyTypeMaster?      @relation(fields: [propertyTypeId], references: [id], onDelete: SetNull)
  responses    BulkAssessmentResponse[]

  @@index([status, createdAt(sort: Desc)])
  @@index([userId])
  @@map("bulk_assessments")
}

model BulkAssessmentResponse {
  id               String         @id @default(uuid()) @db.Uuid
  assessmentId     String         @db.Uuid
  agentId          String         @db.Uuid
  assessedPrice    BigInt?
  priceRangeMin    BigInt?
  priceRangeMax    BigInt?
  comments         String?        @db.Text
  proposalDocument String?        @db.VarChar(500) // FileBox URL
  status           ResponseStatus @default(PENDING)
  submittedAt      DateTime?      @db.Timestamptz
  viewedAt         DateTime?      @db.Timestamptz
  createdAt        DateTime       @default(now()) @db.Timestamptz

  // Relations
  assessment BulkAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  agent      Agent          @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([agentId, createdAt(sort: Desc)])
  @@map("bulk_assessment_responses")
}

enum AssessmentStatus {
  PENDING
  SENT_TO_AGENTS
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ResponseStatus {
  PENDING
  SUBMITTED
  VIEWED
}

// ============================================
// Q&A [cyan]
// ============================================

model Question {
  id             String         @id @default(uuid()) @db.Uuid
  questionNumber String         @unique @db.VarChar(50)
  title          String         @db.VarChar(200)
  content        String         @db.Text
  categoryId     String?        @db.Uuid
  tags           String[] // GINインデックス
  viewCount      Int            @default(0)
  answerCount    Int            @default(0)
  status         QuestionStatus @default(OPEN)
  authorId       String         @db.Uuid
  bestAnswerId   String?        @db.Uuid
  createdAt      DateTime       @default(now()) @db.Timestamptz
  updatedAt      DateTime       @updatedAt @db.Timestamptz
  deletedAt      DateTime?      @db.Timestamptz

  // Relations
  author   User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category QuestionCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  answers  Answer[]

  @@index([status, createdAt(sort: Desc)])
  @@index([categoryId, status])
  @@index([authorId])
  @@map("questions")
}

model Answer {
  id           String    @id @default(uuid()) @db.Uuid
  questionId   String    @db.Uuid
  content      String    @db.Text
  goodCount    Int       @default(0)
  isBestAnswer Boolean   @default(false)
  authorId     String?   @db.Uuid
  agentId      String?   @db.Uuid // 業者として回答の場合
  createdAt    DateTime  @default(now()) @db.Timestamptz
  updatedAt    DateTime  @updatedAt @db.Timestamptz
  deletedAt    DateTime? @db.Timestamptz

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  author   User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)
  agent    Agent?   @relation(fields: [agentId], references: [id], onDelete: SetNull)

  @@index([questionId, createdAt])
  @@index([authorId])
  @@index([agentId])
  @@map("answers")
}

enum QuestionStatus {
  OPEN
  ANSWERED
  RESOLVED
  CLOSED
}

// ============================================
// マスタデータ [lightblue/purple]
// ============================================

model FeatureMaster {
  id           String          @id @default(uuid()) @db.Uuid
  code         String          @unique @db.VarChar(50)
  name         String          @db.VarChar(100)
  category     FeatureCategory
  icon         String?         @db.VarChar(50)
  displayOrder Int             @default(0)
  isActive     Boolean         @default(true)

  // Relations
  properties PropertyFeature[]

  @@index([category, displayOrder])
  @@map("feature_masters")
}

model RegionMaster {
  id           String  @id @default(uuid()) @db.Uuid
  code         String  @unique @db.VarChar(20)
  name         String  @db.VarChar(50)
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Relations
  areas AreaMaster[]

  @@map("region_masters")
}

model AreaMaster {
  id             String  @id @default(uuid()) @db.Uuid
  regionId       String? @db.Uuid
  prefectureCode String  @db.VarChar(10)
  prefecture     String  @db.VarChar(10)
  cityCode       String? @db.VarChar(10)
  city           String  @db.VarChar(50)
  displayOrder   Int     @default(0)
  isActive       Boolean @default(true)

  // Relations
  region     RegionMaster? @relation(fields: [regionId], references: [id], onDelete: SetNull)
  properties Property[]

  @@unique([prefecture, city])
  @@index([regionId])
  @@index([prefecture])
  @@map("area_masters")
}

model PropertyTypeMaster {
  id           String  @id @default(uuid()) @db.Uuid
  code         String  @unique @db.VarChar(50)
  name         String  @db.VarChar(50)
  description  String? @db.Text
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Relations
  properties      Property[]
  bulkAssessments BulkAssessment[]

  @@map("property_type_masters")
}

model PropertyCategoryMaster {
  id           String  @id @default(uuid()) @db.Uuid
  code         String  @unique @db.VarChar(50)
  name         String  @db.VarChar(100)
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Relations
  properties Property[]

  @@map("property_category_masters")
}

model FloorPlanMaster {
  id           String  @id @default(uuid()) @db.Uuid
  code         String  @unique @db.VarChar(20) // 1R, 1K, 1DK...
  name         String  @db.VarChar(50)
  roomCount    Int?
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Relations
  properties Property[]

  @@map("floor_plan_masters")
}

model RouteMaster {
  id           String  @id @default(uuid()) @db.Uuid
  code         String  @unique @db.VarChar(50)
  name         String  @db.VarChar(100)
  companyName  String? @db.VarChar(100)
  lineColor    String? @db.VarChar(20) // 路線カラー
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Relations
  stations Station[]

  @@index([displayOrder])
  @@map("route_masters")
}

model Station {
  id           String   @id @default(uuid()) @db.Uuid
  code         String   @unique @db.VarChar(50)
  name         String   @db.VarChar(100)
  nameKana     String?  @db.VarChar(100)
  routeId      String?  @db.Uuid
  prefecture   String?  @db.VarChar(10)
  city         String?  @db.VarChar(50)
  latitude     Decimal? @db.Decimal(10, 7)
  longitude    Decimal? @db.Decimal(10, 7)
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)

  // Relations
  route            RouteMaster?      @relation(fields: [routeId], references: [id], onDelete: SetNull)
  propertyStations PropertyStation[]

  @@unique([name, routeId])
  @@index([routeId])
  @@index([prefecture])
  @@map("stations")
}

model QuestionCategory {
  id           String  @id @default(uuid()) @db.Uuid
  code         String  @unique @db.VarChar(50)
  name         String  @db.VarChar(100)
  description  String? @db.Text
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Relations
  questions Question[]

  @@map("question_categories")
}

enum FeatureCategory {
  EQUIPMENT // 設備
  CONDITION // 条件
  ENVIRONMENT // 周辺環境
  SECURITY // セキュリティ
  OTHER // その他
}

// ============================================
// システム・共通 [gray]
// ============================================

model Mail {
  id                String     @id @default(uuid()) @db.Uuid
  fromEmail         String     @db.VarChar(255)
  fromName          String?    @db.VarChar(100)
  toEmail           String     @db.VarChar(255)
  toName            String?    @db.VarChar(100)
  ccEmail           String[]
  bccEmail          String[]
  subject           String     @db.VarChar(500)
  bodyText          String     @db.Text
  bodyHtml          String?    @db.Text
  status            MailStatus @default(DRAFT)
  mailType          MailType   @default(GENERAL)
  templateCode      String?    @db.VarChar(100)
  templateVariables Json?      @db.JsonB
  errorMessage      String?    @db.Text
  userId            String?    @db.Uuid
  retryCount        Int        @default(0)
  scheduledAt       DateTime?  @db.Timestamptz
  sentAt            DateTime?  @db.Timestamptz
  createdAt         DateTime   @default(now()) @db.Timestamptz

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status, scheduledAt])
  @@index([userId, createdAt(sort: Desc)])
  @@map("mails")
}

model FileBox {
  id           String    @id @default(uuid()) @db.Uuid
  bucketName   String    @db.VarChar(100) // Supabase Storage bucket
  storagePath  String    @db.VarChar(500) // Storage内のパス
  fileName     String    @db.VarChar(255)
  originalName String    @db.VarChar(255)
  publicUrl    String?   @db.VarChar(500)
  mimeType     String    @db.VarChar(100)
  fileSize     BigInt // bytes
  category     String?   @db.VarChar(100) // property_image, document, avatar, other
  metadata     Json?     @db.JsonB // width, height, duration等
  userId       String?   @db.Uuid
  isPublic     Boolean   @default(false)
  createdAt    DateTime  @default(now()) @db.Timestamptz
  updatedAt    DateTime  @updatedAt @db.Timestamptz
  deletedAt    DateTime? @db.Timestamptz

  // Relations
  user           User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  propertyImages PropertyImage[]

  @@index([userId, category])
  @@index([category, createdAt(sort: Desc)])
  @@map("file_boxes")
}

model SystemSetting {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       Json     @db.JsonB
  valueType   String   @db.VarChar(50) // string, number, boolean, json
  category    String?  @db.VarChar(50) // general, mail, payment, feature_flag
  description String?  @db.Text
  isPublic    Boolean  @default(false) // フロントエンドで参照可能か
  updatedById String?  @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  // Relations
  updatedBy User? @relation(fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([category, key])
  @@map("system_settings")
}

model AuditLog {
  id            String      @id @default(uuid()) @db.Uuid
  tableName     String      @db.VarChar(100)
  recordId      String      @db.Uuid
  action        AuditAction
  oldData       Json?       @db.JsonB
  newData       Json?       @db.JsonB
  changedFields String[] // 変更されたフィールド一覧
  userId        String?     @db.Uuid
  userEmail     String?     @db.VarChar(255) // 非正規化
  ipAddress     String?     @db.VarChar(45)
  userAgent     String?     @db.Text
  sessionId     String?     @db.VarChar(100)
  createdAt     DateTime    @default(now()) @db.Timestamptz

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tableName, recordId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

model Notification {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  type      String    @db.VarChar(100) // inquiry_received, answer_posted, price_changed, etc
  title     String    @db.VarChar(200)
  message   String    @db.Text
  linkUrl   String?   @db.VarChar(500)
  isRead    Boolean   @default(false)
  readAt    DateTime? @db.Timestamptz
  metadata  Json?     @db.JsonB
  createdAt DateTime  @default(now()) @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@map("notifications")
}

enum MailStatus {
  DRAFT
  QUEUED
  SENDING
  SENT
  FAILED
}

enum MailType {
  GENERAL
  INQUIRY_REPLY
  NOTIFICATION
  CAMPAIGN
  SYSTEM
}

enum AuditAction {
  INSERT
  UPDATE
  DELETE
}
