---
description: 
globs: 
alwaysApply: true
---
### スキーマ管理

- データベーススキーマの唯一の真実のソース（Single Source of Truth）は `schema.prisma` ファイルです。
- Supabase UIを通じてデータベーススキーマを直接変更しないでください。スキーマの変更を適用するには、常に `prisma migrate dev` を使用してください。

### データベースアクセス

- すべてのデータベースクエリは、**Prisma Client** を通じて実行しなければなりません。テーブルへの直接アクセスのためにSupabase JSライブラリ（`supabase-js`）を使用しないでください。
- 単一の共有Prisma Clientインスタンスをインスタンス化し、中央ファイル（例：`src/lib/prisma.ts`）からエクスポートしてください。

### 認証と認可

- すべてのユーザー認証タスク（サインアップ、サインイン、セッション管理）には、**Supabase Auth client**（`@supabase/auth-helpers-nextjs`）を使用してください。
- バックエンドロジック（例：APIルート、Server Actions）は、機密性の高い操作を実行する前に、Supabaseからユーザーのセッションを検証しなければなりません。
- 特にユーザー固有のデータを含むテーブルに対して、データ保護の追加レイヤーとしてSupabaseでRow-Level Security (RLS) ポリシーを実装してください。

### APIとサーバーロジック

- すべてのデータベースと対話するサーバーサイドロジックは、**Server Actions** または APIルートに配置してください。
- クライアントからの入力データ（例：フォーム送信）は、Prismaに渡される前にサーバー上で **Zod** を使用して検証されなければなりません。
- ミューテーションや機密操作を実行するすべてのサーバーサイドロジックを `try/catch` ブロックでラップし、堅牢なエラーハンドリングを行ってください。

### データ同期

- 新しいユーザーがSupabase Auth経由でサインアップした際、データベーストリガーと関数、または専用のAPI呼び出しを使用して、パブリックな `users` テーブル（または類似のもの）に対応するレコードを作成してください。これにより、Supabaseの `auth.users` とパブリックユーザープロファイルが同期されます。
